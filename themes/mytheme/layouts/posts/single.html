{{- define "main" -}}
<article class="blog-post">
  <div class="post-header">
    <div class="post-breadcrumb">
      <a href="/posts">‚Üê T·∫•t c·∫£ b√†i vi·∫øt</a>
    </div>
    
    <h1 class="post-title">{{ .Title }}</h1>
    
    {{ if .Params.description }}
    <p class="post-description">{{ .Params.description }}</p>
    {{ end }}
    
    <div class="post-meta">
      <div class="meta-left">
        <span class="post-date">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          {{ .Date.Format "02/01/2006" }}
        </span>
        <span class="reading-time">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          {{ math.Round (div (countwords .Content) 200.0) }} ph√∫t ƒë·ªçc
        </span>
      </div>
      {{ if .Params.tags }}
      <div class="post-tags">
        {{ range .Params.tags }}
        <span class="post-tag">{{ . }}</span>
        {{ end }}
      </div>
      {{ end }}
    </div>
  </div>

  {{ if .Params.image }}
  <div class="post-featured-image">
    <img src="{{ .Params.image }}" alt="{{ .Title }}">
  </div>
  {{ end }}

  {{ if .Params.video }}
  <div class="post-featured-video">
    <div class="video-wrapper">
      <iframe 
        src="https://www.youtube.com/embed/{{ .Params.video }}" 
        title="YouTube video player" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
        referrerpolicy="strict-origin-when-cross-origin" 
        allowfullscreen>
      </iframe>
    </div>
  </div>
  {{ end }}

  <div class="post-content">
    {{ .Content }}
  </div>

  <!-- Comments Section -->
  <div class="comments-section">
    <h3 class="comments-title">üí¨ B√¨nh lu·∫≠n <span id="commentCount"></span></h3>
    
    <!-- Comment Form -->
    <div class="comment-form">
      <input type="text" id="commentName" placeholder="T√™n c·ªßa b·∫°n" maxlength="50">
      <textarea id="commentText" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." rows="3" maxlength="500"></textarea>
      <button onclick="addComment()" class="submit-comment">G·ª≠i b√¨nh lu·∫≠n</button>
    </div>

    <!-- Filter & Sort -->
    <div class="comment-filter">
      <button onclick="filterComments('top')" class="filter-btn active" id="filter-top">üëç Ch·∫•t l∆∞·ª£ng nh·∫•t</button>
      <button onclick="filterComments('newest')" class="filter-btn" id="filter-newest">üïê M·ªõi nh·∫•t</button>
    </div>

    <!-- Comments List -->
    <div id="commentsList" class="comments-list"></div>
    
    <button id="showAllBtn" class="show-all-btn" onclick="showAllComments()" style="display:none;">
      Xem t·∫•t c·∫£ b√¨nh lu·∫≠n
    </button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase Configuration - B·∫†N C·∫¶N THAY B·∫∞NG CONFIG C·ª¶A FIREBASE PROJECT
    const firebaseConfig = {
  apiKey: "AIzaSyAdjhCEVyCd-Lr5M6wIrcVIdUGZK5nnMRQ",
  authDomain: "project-profile-e5576.firebaseapp.com",
  databaseURL: "https://project-profile-e5576-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "project-profile-e5576",
  storageBucket: "project-profile-e5576.firebasestorage.app",
  messagingSenderId: "141833177870",
  appId: "1:141833177870:web:510eb87ec5b5749d9e255f",
  measurementId: "G-8EZ42LZQ09"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    const POST_ID = '{{ .RelPermalink }}'.replace(/\//g, '_');
    let currentFilter = 'top';
    let showAll = false;
    let commentsCache = [];

    function getComments() {
      return commentsCache;
    }

    function loadCommentsFromFirebase() {
      const commentsRef = database.ref('comments/' + POST_ID);
      commentsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          commentsCache = Object.values(data).map(comment => ({
            ...comment,
            likedBy: comment.likedBy || [],
            likes: comment.likes || 0
          }));
        } else {
          commentsCache = [];
        }
        renderComments();
      });
    }

    function addComment() {
      const name = document.getElementById('commentName').value.trim();
      const text = document.getElementById('commentText').value.trim();
      
      if (!name || !text) {
        alert('Vui l√≤ng nh·∫≠p t√™n v√† n·ªôi dung b√¨nh lu·∫≠n!');
        return;
      }

      const newComment = {
        id: Date.now(),
        name: name,
        text: text,
        likes: 0,
        timestamp: new Date().toISOString(),
        likedBy: []
      };

      // Save to Firebase
      const commentsRef = database.ref('comments/' + POST_ID);
      commentsRef.push(newComment).then(() => {
        document.getElementById('commentName').value = '';
        document.getElementById('commentText').value = '';
      }).catch((error) => {
        alert('L·ªói khi g·ª≠i b√¨nh lu·∫≠n: ' + error.message);
      });
    }

    function likeComment(commentId) {
      const userId = getUserId();
      const commentsRef = database.ref('comments/' + POST_ID);
      
      commentsRef.once('value').then((snapshot) => {
        const comments = snapshot.val();
        if (!comments) return;
        
        // Find comment by id
        let commentKey = null;
        let comment = null;
        
        Object.keys(comments).forEach(key => {
          if (comments[key].id === commentId) {
            commentKey = key;
            comment = comments[key];
          }
        });
        
        if (comment && commentKey) {
          const likedBy = comment.likedBy || [];
          const likedIndex = likedBy.indexOf(userId);
          
          if (likedIndex > -1) {
            likedBy.splice(likedIndex, 1);
            comment.likes = Math.max(0, (comment.likes || 0) - 1);
          } else {
            likedBy.push(userId);
            comment.likes = (comment.likes || 0) + 1;
          }
          
          comment.likedBy = likedBy;
          
          // Update Firebase
          database.ref('comments/' + POST_ID + '/' + commentKey).set(comment);
        }
      });
    }

    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);

      if (diff < 60) return 'v·ª´a xong';
      if (diff < 3600) return Math.floor(diff / 60) + ' ph√∫t tr∆∞·ªõc';
      if (diff < 86400) return Math.floor(diff / 3600) + ' gi·ªù tr∆∞·ªõc';
      if (diff < 2592000) return Math.floor(diff / 86400) + ' ng√†y tr∆∞·ªõc';
      
      return date.toLocaleDateString('vi-VN');
    }

    function filterComments(filter) {
      currentFilter = filter;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('filter-' + filter).classList.add('active');
      
      renderComments();
    }

    function showAllComments() {
      showAll = true;
      renderComments();
    }

    function renderComments() {
      let comments = getComments();
      
      // Update comment count in title
      const countSpan = document.getElementById('commentCount');
      if (comments.length > 0) {
        countSpan.textContent = `(${comments.length})`;
      } else {
        countSpan.textContent = '';
      }
      
      if (currentFilter === 'top') {
        comments.sort((a, b) => b.likes - a.likes);
      } else {
        comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }

      const userId = getUserId();
      const displayComments = showAll ? comments : comments.slice(0, 3);
      
      const html = displayComments.map(comment => {
        const likedBy = comment.likedBy || [];
        const likes = comment.likes || 0;
        const hasLiked = likedBy.includes(userId);
        return `
          <div class="comment-item">
            <div class="comment-avatar">${comment.name.charAt(0).toUpperCase()}</div>
            <div class="comment-content">
              <div class="comment-header">
                <strong>${comment.name}</strong>
                <span class="comment-time">${formatDate(comment.timestamp)}</span>
              </div>
              <p class="comment-text">${comment.text}</p>
              <button onclick="likeComment(${comment.id})" class="like-btn ${hasLiked ? 'liked' : ''}">
                ‚ù§Ô∏è ${likes}
              </button>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('commentsList').innerHTML = html || '<p class="no-comments">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>';
      
      const showAllBtn = document.getElementById('showAllBtn');
      if (comments.length > 3 && !showAll) {
        showAllBtn.style.display = 'block';
        showAllBtn.textContent = `Xem t·∫•t c·∫£ ${comments.length} b√¨nh lu·∫≠n`;
      } else {
        showAllBtn.style.display = 'none';
      }
    }

    // Initial load from Firebase
    loadCommentsFromFirebase();
  </script>

  <div class="post-footer">
    <a href="/posts" class="back-to-blog">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
      Xem t·∫•t c·∫£ b√†i vi·∫øt
    </a>
  </div>
</article>
{{- end -}}
